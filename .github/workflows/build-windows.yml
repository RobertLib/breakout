name: Build Windows

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  SDL3_VERSION: "3.3.4"
  SDL3_TAG: "prerelease-3.3.4"
  SDL3_TTF_VERSION: "3.2.2"

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-libogg
            mingw-w64-x86_64-libvorbis
            mingw-w64-x86_64-flac
            mingw-w64-x86_64-mpg123
            mingw-w64-x86_64-opus
            mingw-w64-x86_64-opusfile
            mingw-w64-x86_64-libmodplug
            make
            unzip
            git
            vim

      - name: Download and build SDL3 libraries
        shell: msys2 {0}
        run: |
          mkdir -p libs/win

          # Download SDL3 prerelease (SDL3_mixer requires 3.3.3+)
          echo "Downloading SDL3 ${SDL3_VERSION}..."
          curl -L -o sdl3.zip "https://github.com/libsdl-org/SDL/releases/download/${SDL3_TAG}/SDL3-devel-${SDL3_VERSION}-mingw.zip"
          unzip -q sdl3.zip
          mv SDL3-${SDL3_VERSION}/x86_64-w64-mingw32 libs/win/SDL3
          rm -rf SDL3-${SDL3_VERSION} sdl3.zip

          # Download SDL3_ttf
          echo "Downloading SDL3_ttf ${SDL3_TTF_VERSION}..."
          curl -L -o sdl3_ttf.zip "https://github.com/libsdl-org/SDL_ttf/releases/download/release-${SDL3_TTF_VERSION}/SDL3_ttf-devel-${SDL3_TTF_VERSION}-mingw.zip"
          unzip -q sdl3_ttf.zip
          mv SDL3_ttf-${SDL3_TTF_VERSION}/x86_64-w64-mingw32 libs/win/SDL3_ttf
          rm -rf SDL3_ttf-${SDL3_TTF_VERSION} sdl3_ttf.zip

          # Build SDL3_mixer from source (no mingw release available)
          echo "Building SDL3_mixer from source..."
          git clone --depth 1 --branch main https://github.com/libsdl-org/SDL_mixer.git
          cd SDL_mixer
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=$PWD/../libs/win/SDL3_mixer \
            -DCMAKE_PREFIX_PATH=$PWD/../libs/win/SDL3 \
            -DSDL3MIXER_VENDORED=OFF \
            -DSDL3MIXER_FLAC=ON \
            -DSDL3MIXER_MOD=ON \
            -DSDL3MIXER_MP3=ON \
            -DSDL3MIXER_OPUS=ON \
            -DSDL3MIXER_VORBIS=VORBISFILE
          cmake --build build
          cmake --install build
          cd ..
          rm -rf SDL_mixer

          echo "Libraries ready:"
          ls -la libs/win/

      - name: Build
        shell: msys2 {0}
        run: |
          # Make scripts executable
          chmod +x embed_assets.sh

          # Build release version (no editor)
          make -f makefile.windows release

      - name: Prepare release package
        shell: msys2 {0}
        run: |
          mkdir -p release/breakout
          cp build/breakout.exe release/breakout/
          cp README.md release/breakout/ 2>/dev/null || true
          cp LICENSE release/breakout/ 2>/dev/null || true

          # Copy SDL3 DLLs
          cp libs/win/SDL3/bin/*.dll release/breakout/
          cp libs/win/SDL3_ttf/bin/*.dll release/breakout/

          # Copy SDL3_mixer DLLs (correct path)
          if [ -d "libs/win/SDL3_mixer/bin" ]; then
            cp libs/win/SDL3_mixer/bin/*.dll release/breakout/ 2>/dev/null || true
          fi
          if [ -d "libs/win/SDL3_mixer/lib" ]; then
            find libs/win/SDL3_mixer/lib -name '*.dll' -exec cp {} release/breakout/ \; 2>/dev/null || true
          fi

          # Copy audio codec DLLs from MSYS2
          cp /mingw64/bin/libogg-0.dll release/breakout/ 2>/dev/null || true
          cp /mingw64/bin/libvorbis-0.dll release/breakout/ 2>/dev/null || true
          cp /mingw64/bin/libvorbisfile-3.dll release/breakout/ 2>/dev/null || true
          cp /mingw64/bin/libFLAC.dll release/breakout/ 2>/dev/null || true
          cp /mingw64/bin/libmpg123-0.dll release/breakout/ 2>/dev/null || true
          cp /mingw64/bin/libopus-0.dll release/breakout/ 2>/dev/null || true
          cp /mingw64/bin/libopusfile-0.dll release/breakout/ 2>/dev/null || true
          cp /mingw64/bin/libmodplug-1.dll release/breakout/ 2>/dev/null || true

          # Copy only essential MinGW runtime DLLs (no C++ runtime needed for C project)
          cp /mingw64/bin/libgcc_s_seh-1.dll release/breakout/ 2>/dev/null || true
          cp /mingw64/bin/libwinpthread-1.dll release/breakout/ 2>/dev/null || true

          echo "Release contents:"
          ls -la release/breakout/

      - name: Upload Windows build
        uses: actions/upload-artifact@v4
        with:
          name: Breakout-Windows
          path: release/breakout/
          retention-days: 30
